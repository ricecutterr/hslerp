{% extends 'admin/layout.html' %}
{% block title %}Configurator - HSL ERP{% endblock %}
{% block head %}
<style>
.btn-hsl-cfg{background:#61993B;color:white;border:none}.btn-hsl-cfg:hover{background:#4a7a2e;color:white}
.panel{background:white;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px;height:100%}
.product-list{max-height:52vh;overflow-y:auto;border:1px solid #e9ecef;border-radius:8px}
.product-item{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:.88rem}
.product-item:hover{background:#f0f9e8}.product-item.active{background:#d4edba;font-weight:500}
.tab-btn{border:1px solid #dee2e6;background:white;padding:4px 10px;border-radius:4px;font-size:.8rem;cursor:pointer}
.tab-btn.active{background:#1D2F34;color:white;border-color:#1D2F34}
.item-card{background:#fafbfc;border:1px solid #e9ecef;border-radius:8px;padding:12px;margin-bottom:10px}
.acc-std{color:#888;font-style:italic;font-size:.82rem}
.acc-opt{font-size:.85rem;border-bottom:1px dotted #e9ecef;padding:3px 0}
.price-tag{font-weight:700;color:#61993B}
.totals-box{background:linear-gradient(135deg,#1D2F34,#243d44);color:white;border-radius:10px;padding:16px;margin-top:12px}
.totals-box .tl{display:flex;justify-content:space-between;padding:4px 0}
.totals-box .tm{font-size:1.15rem;font-weight:700;border-top:2px solid rgba(255,255,255,.3);padding-top:8px;margin-top:8px}
.modal-header{background:#1D2F34;color:white}.modal-header .btn-close{filter:invert(1)}
</style>
{% endblock %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2><i class="bi bi-gear me-2"></i>Configurator Oferte</h2>
    <a href="/admin/oferte" class="btn btn-outline-secondary"><i class="bi bi-list me-1"></i>Toate Ofertele</a>
</div>

<div class="row g-3">
<!-- LEFT: Products -->
<div class="col-md-4 col-lg-3"><div class="panel">
<h6 class="fw-bold mb-2" style="color:#1D2F34">Produse Disponibile</h6>
<input id="prod-search" class="form-control form-control-sm mb-2" placeholder="üîç CautƒÉ...">
<div class="mb-2 d-flex flex-wrap gap-1" id="prod-tabs"></div>
<div class="product-list" id="prod-list"></div>
<button class="btn btn-hsl btn-sm w-100 mt-2" onclick="addSelectedProduct()">‚ûï AdaugƒÉ Produs</button>
<button class="btn btn-outline-secondary btn-sm w-100 mt-1" onclick="addStandaloneAcc()">üîß AdaugƒÉ Accesoriu Standalone</button>
</div></div>
<!-- RIGHT: Config -->
<div class="col-md-8 col-lg-9"><div class="panel">
<h6 class="fw-bold mb-2" style="color:#1D2F34">Configura»õie OfertƒÉ</h6>
<div class="d-flex align-items-center gap-3 mb-3 p-2 rounded" style="background:#f8f9fa;border:1px solid #e9ecef">
<strong class="small">DISCOUNT/ADAOS:</strong>
<div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="dm" id="dm-ind" checked onchange="renderItems()"><label class="form-check-label small" for="dm-ind">Individual</label></div>
<div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="dm" id="dm-glob" onchange="renderItems()"><label class="form-check-label small" for="dm-glob">Global</label></div>
<div id="gd-wrap" style="display:none"><input id="gd-val" type="number" step="0.01" value="0" class="form-control form-control-sm" style="width:80px" oninput="renderItems()"><small class="text-muted ms-1">%</small></div>
</div>
<div id="items-box" style="max-height:52vh;overflow-y:auto"><p class="text-muted text-center py-4">Niciun produs adƒÉugat</p></div>
<div class="totals-box">
<div class="tl"><span>SUBTOTAL:</span><span id="t-sub">0.00 EUR</span></div>
<div class="tl"><span>TVA 19%:</span><span id="t-tva">0.00 EUR</span></div>
<div class="tl tm"><span>TOTAL GENERAL:</span><span id="t-tot">0.00 EUR</span></div>
</div>
<button class="btn btn-hsl w-100 mt-3 py-2 fw-bold" id="saveBtn" onclick="genOffer()">üíæ GenereazƒÉ OfertƒÉ Excel</button>
</div></div>
</div>

<!-- Modal Config -->
<div class="modal fade" id="cfgM" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title" id="cfgT"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body" id="cfgB" style="max-height:75vh;overflow-y:auto"></div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">AnuleazƒÉ</button>
<button class="btn btn-hsl" id="cfgS">AdaugƒÉ √Æn OfertƒÉ</button></div>
</div></div></div>

<!-- Modal Client -->
<div class="modal fade" id="cliM" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Informa»õii Client & Generare OfertƒÉ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
<div class="modal-body">
<div class="mb-2"><label class="form-label fw-bold">Client existent</label><select id="ci-ex" class="form-select" onchange="onCliSel()">
<option value="">-- Client nou --</option>
{% for c in clienti %}<option value="{{c.id}}" data-n="{{c.nume}}" data-e="{{c.email or ''}}" data-p="{{c.telefon or ''}}" data-a="{{c.adresa or ''}}">{{c.nume}}{% if c.cui %} ({{c.cui}}){% endif %}</option>{% endfor %}
</select></div><hr>
<div class="mb-2"><label class="form-label">Valabilitate (zile)</label><input id="ci-v" class="form-control" type="number" value="30"></div>
<div class="mb-2"><label class="form-label">Observa»õii</label><textarea id="ci-obs" class="form-control" rows="2"></textarea></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">AnuleazƒÉ</button>
<button class="btn btn-hsl" id="cliS">SalveazƒÉ OfertƒÉ</button></div>
</div></div></div>
{% endblock %}

{% block scripts %}
<script>
const J=(u,o={})=>{o.headers={'Content-Type':'application/json',...o.headers};if(o.body&&typeof o.body==='object')o.body=JSON.stringify(o.body);return fetch(u,o).then(r=>r.json())};
let prods=[],filtered=[],items=[],curCat='All',selIdx=-1,cfgMod,cliMod,editOfertaId=null;
document.addEventListener('DOMContentLoaded',async()=>{
    cfgMod=new bootstrap.Modal('#cfgM');cliMod=new bootstrap.Modal('#cliM');
    prods=await J('/api/cfg/configurator/produse');
    buildTabs();filter();
    document.getElementById('prod-search').addEventListener('input',filter);
    // EDIT MODE: load existing offer
    const params=new URLSearchParams(window.location.search);
    if(params.get('edit')){
        editOfertaId=parseInt(params.get('edit'));
        const data=await J(`/api/oferta/${editOfertaId}/edit-data`);
        if(data.oferta_id){
            // Set client
            if(data.client_id){document.getElementById('ci-ex').value=data.client_id;}
            // Set discount mode
            if(data.discount_mode==='global'){document.getElementById('dm-glob').checked=true;document.getElementById('gd-val').value=data.discount_global||0;}
            // Set valabilitate
            document.getElementById('ci-v').value=data.valabilitate_zile||30;
            // Load items
            items=data.items.map(it=>({...it,cod_baza:it.cod,pret:it.pret_final||it.pret_catalog}));
            renderItems();
            document.querySelector('.page-header h2').innerHTML='<i class="bi bi-pencil me-2"></i>Editare OfertƒÉ #'+editOfertaId;
            document.getElementById('saveBtn').innerHTML='üíæ SalveazƒÉ ModificƒÉrile';
        }
    }
});

function buildTabs(){
    const cats={{cat_produse|tojson}};
    let h=`<span class="tab-btn active" onclick="switchCat('All',this)">All (${prods.length})</span>`;
    cats.forEach(c=>{const n=prods.filter(p=>p.categories.includes(c.id)).length;if(n)h+=`<span class="tab-btn" onclick="switchCat(${c.id},this)">${c.nume} (${n})</span>`;});
    document.getElementById('prod-tabs').innerHTML=h;
}
function switchCat(c,b){curCat=c;document.querySelectorAll('#prod-tabs .tab-btn').forEach(x=>x.classList.remove('active'));if(b)b.classList.add('active');filter();}
function filter(){
    const q=document.getElementById('prod-search').value.toLowerCase();
    filtered=prods.filter(p=>(curCat==='All'||p.categories.includes(curCat))&&(!q||p.cod.toLowerCase().includes(q)||p.denumire.toLowerCase().includes(q)));
    document.getElementById('prod-list').innerHTML=filtered.map((p,i)=>`<div class="product-item" onclick="selProd(this,${i})">${p.cod} - ${p.denumire}</div>`).join('')||'<p class="text-muted p-3 text-center">Niciun produs</p>';
    selIdx=-1;
}
function selProd(el,i){document.querySelectorAll('.product-item').forEach(e=>e.classList.remove('active'));el.classList.add('active');selIdx=i;}

function addSelectedProduct(){
    if(selIdx<0)return alert('SelecteazƒÉ un produs!');
    const p=filtered[selIdx],pt=p.parameter_types||[],accs=p.accessories||[];
    if(pt.length||accs.length)openCfg(p,null);
    else{items.push({tip:'Produs',cod:p.cod,cod_baza:p.cod,denumire:p.denumire,pret:p.pret,pret_catalog:p.pret,pret_final:p.pret,um:p.um,cantitate:1,discount_adaos:0,parametri:{},accesorii:[],dimensiune:''});renderItems();}
}

/* CONFIG DIALOG */
function openCfg(product,existing){
    const pt=product.parameter_types||[];
    const vr=product.variante||{};
    document.getElementById('cfgT').textContent='Configurare: '+product.denumire;
    let h='';
    pt.forEach(pm=>{
        h+=`<div class="mb-3"><label class="form-label fw-bold">${pm.name}:</label>`;
        if(pm.type==='dropdown'){
            const mode=pm.mode||'fix',vals=(pm.values||[]).map(v=>typeof v==='object'?v.label:v);
            const ex=existing?(existing.parametri[pm.key]||''):'';
            if(mode==='completabil')h+=`<input class="form-control cp" data-k="${pm.key}" value="${ex}">`;
            else if(mode==='mixt'){
                h+=`<div class="d-flex gap-2"><select class="form-select cp" data-k="${pm.key}" onchange="cfgPC('${pm.key}')"><option value="">--</option>${vals.map(v=>`<option ${v===ex?'selected':''}>${v}</option>`).join('')}</select>
                <div class="form-check align-self-center"><input class="form-check-input ccb" type="checkbox" data-k="${pm.key}" onchange="tgCust('${pm.key}')"><label class="form-check-label small">Custom</label></div></div>
                <input class="form-control mt-1 cin" data-k="${pm.key}" style="display:none" placeholder="Valoare custom">`;
            } else h+=`<select class="form-select cp" data-k="${pm.key}" onchange="cfgPC('${pm.key}')"><option value="">--</option>${vals.map(v=>`<option ${v===ex?'selected':''}>${v}</option>`).join('')}</select>`;
        } else if(pm.type==='dimension'){
            const dims=pm.predefined_dimensions||[],cust=pm.custom_dimensions!==false;
            const ex=existing?(existing.parametri[pm.key]||''):'';
            h+=`<div class="d-flex gap-2"><select class="form-select cp ds" data-k="${pm.key}" onchange="cfgPC('${pm.key}')"><option value="">--</option>${dims.map(d=>`<option value="${d.value}" data-can="${d.canate||''}" ${d.value===ex?'selected':''}>${d.value}${d.canate?' ('+d.canate+'C)':''}</option>`).join('')}</select>`;
            if(cust)h+=`<div class="form-check align-self-center"><input class="form-check-input dcb" type="checkbox" data-k="${pm.key}" onchange="tgDim('${pm.key}')"><label class="form-check-label small">Custom</label></div>`;
            h+=`</div>`;
            if(cust)h+=`<div class="dcf mt-1" data-k="${pm.key}" style="display:none"><div class="d-flex gap-2">
                <input class="form-control form-control-sm dw" data-k="${pm.key}" placeholder="LƒÉ»õime mm">
                <input class="form-control form-control-sm dh" data-k="${pm.key}" placeholder="√énƒÉl»õime mm">
                ${pm.has_canate?`<select class="form-select form-select-sm dcan" data-k="${pm.key}" style="width:80px"><option>1</option><option>2</option><option>3</option><option>4</option></select>`:''}
                <input class="form-control form-control-sm dp" data-k="${pm.key}" placeholder="Pre»õ EUR" type="number" step="0.01">
            </div></div>`;
        }
        h+=`</div>`;
    });
    h+=`<div class="p-2 rounded mb-3" style="background:#f8f9fa;border:1px solid #e9ecef"><strong>Pre»õ:</strong> <span id="cfg-pr" class="price-tag">--</span></div>`;
    h+=`<div class="mb-3"><label class="form-label fw-bold">Cantitate:</label><input id="cfg-q" type="number" min="1" value="${existing?existing.cantitate:1}" class="form-control" style="width:100px"></div>`;
    h+=`<div id="cfg-acc"></div>`;
    document.getElementById('cfgB').innerHTML=h;

    // Accessories - render from product.accessories
    const accs=product.accessories||[];
    console.log('Product accessories:', accs);
    if(accs.length){
        const std=accs.filter(a=>a.status==='standard'),opt=accs.filter(a=>a.status==='optional');
        let ah='<hr><h6 class="fw-bold">Accesorii</h6>';
        if(std.length){ah+='<div class="mb-2"><small class="text-muted fw-bold">STANDARD (incluse):</small>';std.forEach(a=>ah+=`<div class="acc-std">‚Ä¢ ${a.denumire} (standard)</div>`);ah+='</div>';}
        if(opt.length){ah+='<small class="text-muted fw-bold">OP»öIONALE:</small>';
            opt.forEach(a=>{
                const pret=(a.pret||0).toFixed(2);
                ah+=`<div class="acc-opt d-flex align-items-center gap-2"><input class="form-check-input ack" type="checkbox" data-c="${a.cod}" data-p="${a.pret||0}" data-pm="${a.pret_mode||'fix'}" data-d="${a.denumire}" data-u="${a.um||'buc'}">
                <span class="flex-grow-1">${a.denumire} (${pret} EUR)</span><span class="small text-muted">Cant:</span>
                <input type="number" class="form-control form-control-sm aq" data-c="${a.cod}" value="1" min="1" style="width:55px"></div>`;
            });
        }
        document.getElementById('cfg-acc').innerHTML=ah;
        document.getElementById('cfg-acc').dataset.std=JSON.stringify(std);
    } else {
        console.log('No accessories for product', product.cod);
    }

    setTimeout(()=>updPr(product),100);
    document.getElementById('cfgS').onclick=()=>saveCfg(product,existing);
    cfgMod.show();
}

function cfgPC(k){const nm=document.getElementById('cfgT').textContent.replace('Configurare: ','');const p=prods.find(x=>x.denumire===nm);if(p)updPr(p);}
function tgCust(k){const cb=document.querySelector(`.ccb[data-k="${k}"]`),inp=document.querySelector(`.cin[data-k="${k}"]`),sel=document.querySelector(`.cp[data-k="${k}"]`);if(cb.checked){inp.style.display='';sel.disabled=true;}else{inp.style.display='none';sel.disabled=false;}}
function tgDim(k){const cb=document.querySelector(`.dcb[data-k="${k}"]`),f=document.querySelector(`.dcf[data-k="${k}"]`),sel=document.querySelector(`.ds[data-k="${k}"]`);if(cb.checked){f.style.display='';sel.disabled=true;}else{f.style.display='none';sel.disabled=false;}}

function updPr(product){
    const params={};
    document.querySelectorAll('.cp').forEach(el=>{const k=el.dataset.k;if(el.disabled){const cin=document.querySelector(`.cin[data-k="${k}"]`);if(cin)params[k]=cin.value;}else params[k]=el.value;});
    document.querySelectorAll('.dcb:checked').forEach(cb=>{const k=cb.dataset.k;const w=document.querySelector(`.dw[data-k="${k}"]`);const h=document.querySelector(`.dh[data-k="${k}"]`);const p=document.querySelector(`.dp[data-k="${k}"]`);if(w&&h)params[k]=w.value+'x'+h.value;});
    J('/api/cfg/configurator/match-varianta',{method:'POST',body:{cod:product.cod,params:params}}).then(r=>{
        const pr=r.price||product.pret;document.getElementById('cfg-pr').textContent=parseFloat(pr).toFixed(2)+' EUR';
    });
}

function saveCfg(product,existing){
    const params={},pt=product.parameter_types||[];
    pt.forEach(pm=>{
        const k=pm.key;const ccb=document.querySelector(`.ccb[data-k="${k}"]`);
        if(ccb&&ccb.checked){const cin=document.querySelector(`.cin[data-k="${k}"]`);params[k]=cin?cin.value:'';}
        else{const dcb=document.querySelector(`.dcb[data-k="${k}"]`);
            if(dcb&&dcb.checked){const w=document.querySelector(`.dw[data-k="${k}"]`),h=document.querySelector(`.dh[data-k="${k}"]`);params[k]=(w?w.value:'')+'x'+(h?h.value:'');}
            else{const el=document.querySelector(`.cp[data-k="${k}"]`);params[k]=el?el.value:'';}}
    });
    const prStr=document.getElementById('cfg-pr').textContent.replace(' EUR','');const price=parseFloat(prStr)||product.pret;
    const qty=parseInt(document.getElementById('cfg-q').value)||1;
    // Gather accessories
    const accs=[];
    try{const stdData=JSON.parse(document.getElementById('cfg-acc').dataset.std||'[]');stdData.forEach(a=>accs.push({cod:a.cod,denumire:a.denumire,pret:0,pret_catalog:0,pret_final:0,um:a.um||'buc',cantitate:1,is_standard:true}));}catch(e){}
    document.querySelectorAll('.ack:checked').forEach(cb=>{
        const c=cb.dataset.c,aq=document.querySelector(`.aq[data-c="${c}"]`);
        accs.push({cod:c,denumire:cb.dataset.d,pret:parseFloat(cb.dataset.p)||0,pret_catalog:parseFloat(cb.dataset.p)||0,pret_final:parseFloat(cb.dataset.p)||0,um:cb.dataset.u||'buc',cantitate:parseInt(aq?aq.value:1)||1,discount_adaos:0,is_standard:false});
    });
    // Build dimension string
    let dim='';pt.forEach(pm=>{if(pm.type==='dimension')dim=params[pm.key]||'';});
    // Build code
    let code=product.cod;
    const item={tip:'Produs',cod:code,cod_baza:product.cod,denumire:product.denumire,pret:price,pret_catalog:price,pret_final:price,um:product.um,cantitate:qty,discount_adaos:0,parametri:params,accesorii:accs,dimensiune:dim};
    if(existing){const idx=items.indexOf(existing);if(idx>=0)items[idx]=item;}else items.push(item);
    cfgMod.hide();renderItems();
}

/* STANDALONE ACCESSORY */
function addStandaloneAcc(){
    J('/api/cfg/configurator/all-accesorii').then(accs=>{
        if(!accs.length)return alert('Niciun accesoriu standalone!');
        document.getElementById('cfgT').textContent='AdaugƒÉ Accesoriu Standalone';
        let h='<input id="sa-s" class="form-control form-control-sm mb-2" placeholder="üîç CautƒÉ..." oninput="fSa()"><div style="max-height:40vh;overflow-y:auto">';
        accs.forEach(a=>h+=`<div class="product-item sa" onclick="sSa(this)" data-c="${a.cod}" data-d="${a.denumire}" data-p="${a.pret}" data-pm="${a.pret_mode}" data-u="${a.um}">${a.cod} - ${a.denumire} (${a.pret.toFixed(2)} EUR)</div>`);
        h+='</div><hr><div class="d-flex gap-2 align-items-center"><label>Cant:</label><input id="sa-q" type="number" min="1" value="1" class="form-control" style="width:70px">';
        h+='<div id="sa-pw" style="display:none"><label class="ms-2">Pre»õ:</label><input id="sa-p" type="number" step="0.01" value="0" class="form-control" style="width:90px"></div></div>';
        document.getElementById('cfgB').innerHTML=h;
        document.getElementById('cfgS').onclick=()=>{
            const sel=document.querySelector('.sa.active');if(!sel)return alert('SelecteazƒÉ!');
            const p2=parseFloat(document.getElementById('sa-p').value)||parseFloat(sel.dataset.p)||0;
            items.push({tip:'Accesoriu',cod:sel.dataset.c,cod_baza:sel.dataset.c,denumire:sel.dataset.d,um:sel.dataset.u,cantitate:parseInt(document.getElementById('sa-q').value)||1,
                pret:p2,pret_catalog:p2,pret_final:p2,discount_adaos:0,parametri:{},accesorii:[],dimensiune:''});
            cfgMod.hide();renderItems();};
        cfgMod.show();
    });
}
function sSa(el){document.querySelectorAll('.sa').forEach(e=>{e.classList.remove('active');e.style.background='';});el.classList.add('active');el.style.background='#d4edba';
    const pw=document.getElementById('sa-pw');pw.style.display=(el.dataset.pm==='completabil'||el.dataset.pm==='mixt')?'':'none';document.getElementById('sa-p').value=el.dataset.p;}
function fSa(){const q=document.getElementById('sa-s').value.toLowerCase();document.querySelectorAll('.sa').forEach(e=>e.style.display=e.textContent.toLowerCase().includes(q)?'':'none');}

/* RENDER ITEMS */
function renderItems(){
    const box=document.getElementById('items-box'),isGlob=document.getElementById('dm-glob').checked;
    document.getElementById('gd-wrap').style.display=isGlob?'flex':'none';
    const gDisc=parseFloat(document.getElementById('gd-val').value)||0;
    if(!items.length){box.innerHTML='<p class="text-muted text-center py-4">Niciun produs adƒÉugat</p>';calcTot();return;}
    box.innerHTML=items.map((it,idx)=>{
        const disc=isGlob?gDisc:(it.discount_adaos||0);
        const pf=it.pret_catalog*(1+disc/100);it.pret_final=pf;
        let h=`<div class="item-card"><div class="d-flex align-items-center gap-2">
            <span style="background:#1D2F34;color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700">${idx+1}</span>
            <span class="badge ${it.tip==='Produs'?'bg-success':'bg-primary'}" style="font-size:.65rem">${it.tip}</span>
            <strong>${it.cod}</strong> <span class="small text-muted">- ${it.denumire}</span>
            <span class="ms-auto d-flex gap-1">`;
        if(it.tip==='Produs')h+=`<button class="btn btn-outline-secondary btn-sm py-0 px-1" onclick="editItem(${idx})">‚úèÔ∏è</button>`;
        h+=`<button class="btn btn-outline-danger btn-sm py-0 px-1" onclick="delItem(${idx})">üóëÔ∏è</button></span></div>
            <div class="row mt-2 small">
            <div class="col-md-3">Pre»õ catalog: <strong>${it.pret_catalog.toFixed(2)}</strong> EUR</div><div class="col-md-3">`;
        if(!isGlob)h+=`Disc/Ad: <input type="number" step="0.01" value="${it.discount_adaos}" class="form-control form-control-sm d-inline" style="width:65px" onchange="items[${idx}].discount_adaos=parseFloat(this.value)||0;renderItems()"> %`;
        else h+=`<span class="text-primary">(global ${gDisc>0?'+':''}${gDisc.toFixed(2)}%)</span>`;
        h+=`</div><div class="col-md-3"><span class="price-tag">Pre»õ final: ${pf.toFixed(2)} EUR</span></div>
            <div class="col-md-3">Cant: <input type="number" min="1" value="${it.cantitate}" class="form-control form-control-sm d-inline" style="width:55px" onchange="chgQty(${idx},this.value)"> <span class="text-muted">Sub: ${(pf*it.cantitate).toFixed(2)}</span></div></div>`;
        if(it.accesorii&&it.accesorii.length){
            h+=`<div class="mt-2 ms-3" style="border-left:3px solid #e9ecef;padding-left:10px"><small class="text-muted fw-bold">Accesorii:</small>`;
            it.accesorii.forEach(ac=>{
                if(ac.is_standard)h+=`<div class="acc-std">‚Ä¢ ${ac.denumire} (standard)</div>`;
                else{const ad=isGlob?gDisc:(ac.discount_adaos||0);const apf=ac.pret_catalog*(1+ad/100);ac.pret_final=apf;
                    h+=`<div class="acc-opt">‚Ä¢ ${ac.denumire} (${ac.pret_catalog.toFixed(2)}) Cant: ${ac.cantitate} <span class="price-tag ms-1">= ${(apf*ac.cantitate).toFixed(2)} EUR</span></div>`;}
            });
            let subProd=pf*it.cantitate;it.accesorii.filter(a=>!a.is_standard).forEach(a=>{const ad2=isGlob?gDisc:(a.discount_adaos||0);subProd+=a.pret_catalog*(1+ad2/100)*a.cantitate;});
            h+=`<div class="text-end fw-bold small mt-1" style="color:#1D2F34">SUBTOTAL PRODUS (cu acc): ${subProd.toFixed(2)} EUR</div></div>`;
        }
        h+=`</div>`;return h;
    }).join('');calcTot();
}
function chgQty(idx,val){items[idx].cantitate=parseInt(val)||1;renderItems();}
function delItem(idx){items.splice(idx,1);renderItems();}
function editItem(idx){const it=items[idx],p=prods.find(x=>x.cod===it.cod_baza);if(!p)return alert('Produs negƒÉsit!');openCfg(p,it);}

function calcTot(){
    const isGlob=document.getElementById('dm-glob').checked,gD=parseFloat(document.getElementById('gd-val').value)||0;
    let sub=0;
    items.forEach(it=>{const d=isGlob?gD:(it.discount_adaos||0);const pf=it.pret_catalog*(1+d/100);sub+=pf*it.cantitate;
        (it.accesorii||[]).filter(a=>!a.is_standard).forEach(a=>{const ad=isGlob?gD:(a.discount_adaos||0);sub+=a.pret_catalog*(1+ad/100)*a.cantitate;});});
    const tva=sub*0.19,tot=sub+tva;
    document.getElementById('t-sub').textContent=sub.toFixed(2)+' EUR';
    document.getElementById('t-tva').textContent=tva.toFixed(2)+' EUR';
    document.getElementById('t-tot').textContent=tot.toFixed(2)+' EUR';
}

/* GENERATE OFFER */
function genOffer(){
    if(!items.length)return alert('Nu existƒÉ produse!');
    cliMod.show();
    document.getElementById('cliS').onclick=async()=>{
        const sel=document.getElementById('ci-ex');
        const payload={client_id:sel.value?parseInt(sel.value):null,
            valabilitate_zile:parseInt(document.getElementById('ci-v').value)||30,
            observatii:document.getElementById('ci-obs').value||'',
            discount_mode:document.getElementById('dm-glob').checked?'global':'individual',
            discount_global:parseFloat(document.getElementById('gd-val').value)||0,
            items:items.map(it=>({...it,pret_final:it.pret_final||it.pret}))};
        if(editOfertaId)payload.oferta_id=editOfertaId;
        const r=await J('/api/oferta/save',{method:'POST',body:payload});
        if(r.success){
            cliMod.hide();
            if(editOfertaId){
                alert('Oferta actualizatƒÉ!');
                location.href='/admin/oferte/'+r.oferta_id;
            } else {
                if(confirm(`Oferta ${r.numar} salvatƒÉ!\n\nDescarcƒÉ Excel?`))window.open(`/api/oferta/${r.oferta_id}/excel`,'_blank');
                if(confirm('Mergi la pagina ofertei?'))location.href='/admin/oferte/'+r.oferta_id;
                else{items=[];renderItems();}
            }
        } else alert('Eroare: '+JSON.stringify(r));
    };
}
function onCliSel(){
    const o=document.getElementById('ci-ex').selectedOptions[0];
    if(!o||!o.value)return;
}
</script>
{% endblock %}
