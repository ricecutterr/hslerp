{% extends 'admin/layout.html' %}
{% block title %}Chat - HSL ERP{% endblock %}
{% block head %}
<style>
.chat-wrap{display:flex;height:calc(100vh - 120px);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.06)}

/* Sidebar */
.ch-side{width:300px;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;background:#fff}
.ch-side-head{padding:10px 14px;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between}
.ch-side-list{flex:1;overflow-y:auto}
.ch-conv{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;border-bottom:1px solid #f5f5f5;transition:background .12s}
.ch-conv:hover{background:#f0fdf4}
.ch-conv.active{background:#e8f5e9}
.ch-conv .av{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:.95rem;flex-shrink:0}
.ch-conv .info{flex:1;overflow:hidden}
.ch-conv .name{font-weight:600;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ch-conv .preview{font-size:.75rem;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ch-conv .meta{text-align:right;flex-shrink:0}
.ch-conv .time{font-size:.65rem;color:#aaa}
.ch-conv .unread{background:#61993B;color:#fff;border-radius:12px;min-width:18px;height:18px;font-size:.6rem;display:flex;align-items:center;justify-content:center;margin-top:3px;margin-left:auto;padding:0 5px}

/* Main */
.ch-main{flex:1;display:flex;flex-direction:column;position:relative}
.ch-head{padding:10px 16px;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;gap:10px;background:#fff;min-height:54px}
.ch-head .title{font-weight:700;font-size:.95rem}
.ch-head .sub{font-size:.7rem;color:#888}
.ch-msgs{flex:1;overflow-y:auto;padding:16px 40px;background:#efeae2;background-image:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4cfc6' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")}
.ch-empty{display:flex;align-items:center;justify-content:center;flex:1;color:#bbb;flex-direction:column;gap:6px}
.ch-input{padding:10px 16px;border-top:1px solid #e0e0e0;background:#f0f0f0}
.ch-input-row{display:flex;align-items:flex-end;gap:8px}
.ch-input textarea{resize:none;border-radius:8px;padding:8px 12px;font-size:.9rem;border:1px solid #ddd;flex:1;outline:none;transition:border .2s;max-height:120px;background:#fff}
.ch-input textarea:focus{border-color:#61993B;box-shadow:0 0 0 2px rgba(97,153,59,.12)}
.upload-btn{background:none;border:none;color:#888;font-size:1.2rem;cursor:pointer;padding:6px;border-radius:50%;transition:all .15s}
.upload-btn:hover{color:#61993B;background:#e0efe0}
.send-btn{background:#61993B;border:none;color:#fff;width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:background .15s;flex-shrink:0}
.send-btn:hover{background:#4e7d2f}
.file-preview{display:flex;align-items:center;gap:8px;padding:6px 12px;background:#fff;border-radius:8px;margin-bottom:6px;font-size:.8rem;border:1px solid #e0e0e0}
.file-preview .remove{cursor:pointer;color:#dc3545;font-size:.9rem}

/* Messages - WhatsApp style */
.msg-row{display:flex;margin-bottom:2px;padding:0 4px}
.msg-row.first-in-group{margin-top:10px}
.msg-bubble{max-width:65%;padding:5px 8px 3px;border-radius:8px;position:relative;box-shadow:0 1px 1px rgba(0,0,0,.08)}
.msg-bubble.mine{background:#d9fdd3;margin-left:auto;border-top-right-radius:0}
.msg-bubble.other{border-top-left-radius:0}
.msg-bubble .author{font-size:.75rem;font-weight:700;margin-bottom:1px}
.msg-bubble .text{font-size:.88rem;line-height:1.4;color:#111;word-wrap:break-word}
.msg-bubble .text-with-time{display:flex;align-items:flex-end;gap:6px}
.msg-bubble .msg-time{font-size:.6rem;color:#888;white-space:nowrap;flex-shrink:0;margin-left:auto;padding-top:2px;align-self:flex-end}
.msg-bubble .tail{position:absolute;top:0;width:8px;height:13px}
.msg-bubble.mine .tail{right:-8px;fill:#d9fdd3}
.msg-bubble.other .tail{left:-8px}

.date-sep{text-align:center;margin:14px 0 8px}
.date-sep span{background:#fff;padding:4px 14px;border-radius:8px;font-size:.72rem;color:#666;box-shadow:0 1px 1px rgba(0,0,0,.08);font-weight:500}

/* File attachments in bubble */
.file-attach{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.04);border-radius:6px;padding:6px 10px;margin-top:4px;text-decoration:none;color:#333;transition:background .15s}
.file-attach:hover{background:rgba(0,0,0,.08);color:#333}
.file-attach .f-icon{font-size:1.3rem;flex-shrink:0}
.file-attach .f-name{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.file-attach .f-size{font-size:.6rem;color:#888}
.msg-img{max-width:280px;max-height:220px;border-radius:6px;margin-top:3px;cursor:pointer;display:block}

.drop-overlay{position:absolute;inset:0;background:rgba(97,153,59,.12);border:3px dashed #61993B;border-radius:12px;display:flex;align-items:center;justify-content:center;z-index:10;pointer-events:none}
.drop-overlay span{background:#61993B;color:#fff;padding:8px 20px;border-radius:20px;font-weight:700;font-size:.9rem}

/* Bubble colors for different users */
.bubble-c0{background:#fff}
.bubble-c1{background:#dcf8c6}
.bubble-c2{background:#d5f4e6}
.bubble-c3{background:#ffecd2}
.bubble-c4{background:#e8daef}
.bubble-c5{background:#d6eaf8}
.bubble-c6{background:#fadbd8}
.bubble-c7{background:#fdebd0}

@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.msg-new{animation:msgIn .15s ease}
.read-ticks{display:inline-flex;align-items:center;margin-left:3px;cursor:pointer;vertical-align:middle}
.read-ticks svg{width:16px;height:11px}
.read-ticks.tick-sent svg{fill:none;stroke:#92a58c;stroke-width:1.6}
.read-ticks.tick-read svg{fill:none;stroke:#53bdeb;stroke-width:1.6}
.read-info{position:fixed;background:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,.15);padding:8px 12px;z-index:2000;min-width:160px;max-width:240px;font-size:.75rem;border:1px solid #e9ecef}
.read-info .ri-row{display:flex;align-items:center;justify-content:space-between;padding:2px 0}
.read-info .ri-name{font-weight:600;color:#333}
.read-info .ri-time{color:#999;font-size:.65rem}
.read-info .ri-unseen{color:#bbb;font-style:italic;font-size:.7rem}
.read-info .ri-divider{border-top:1px solid #f0f0f0;margin:4px 0}

/* Document reference cards */
.doc-card{display:flex;align-items:stretch;background:#fff;border-radius:8px;overflow:hidden;margin-top:4px;border:1px solid #e0e0e0;max-width:320px;cursor:pointer;transition:box-shadow .15s;text-decoration:none;color:inherit}
.doc-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.12);color:inherit;text-decoration:none}
.doc-card .dc-bar{width:4px;flex-shrink:0}
.doc-card .dc-body{padding:6px 10px;flex:1;overflow:hidden}
.doc-card .dc-title{font-weight:700;font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc-card .dc-sub{font-size:.7rem;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc-card .dc-footer{display:flex;align-items:center;gap:6px;margin-top:2px}
.doc-card .dc-status{font-size:.6rem;padding:1px 6px;border-radius:4px;font-weight:600}
.doc-card .dc-total{font-size:.7rem;font-weight:700;margin-left:auto;color:#333}

/* # Autocomplete dropdown */
.hash-picker{position:absolute;bottom:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 -4px 16px rgba(0,0,0,.12);max-height:280px;overflow-y:auto;z-index:100;margin-bottom:4px}
.hash-picker .hp-head{padding:6px 12px;background:#f8f9fa;border-bottom:1px solid #eee;font-size:.7rem;color:#888;font-weight:600}
.hash-picker .hp-item{display:flex;align-items:center;gap:8px;padding:6px 12px;cursor:pointer;transition:background .1s;border-bottom:1px solid #f5f5f5}
.hash-picker .hp-item:hover,.hash-picker .hp-item.active{background:#f0fdf4}
.hash-picker .hp-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.75rem;flex-shrink:0}
.hash-picker .hp-info{flex:1;overflow:hidden}
.hash-picker .hp-title{font-weight:700;font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hash-picker .hp-sub{font-size:.7rem;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hash-picker .hp-empty{padding:12px;text-align:center;color:#aaa;font-size:.8rem}

/* Reply */
.reply-quote{background:rgba(0,0,0,.06);border-left:3px solid;border-radius:0 6px 6px 0;padding:3px 8px;margin-bottom:3px;cursor:pointer;font-size:.78rem;max-height:44px;overflow:hidden}
.reply-quote .rq-author{font-weight:700;font-size:.7rem}
.reply-quote .rq-text{color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.reply-bar{display:flex;align-items:center;gap:8px;padding:6px 12px;background:#fff;border-radius:8px;margin-bottom:6px;border:1px solid #e0e0e0;border-left:3px solid #61993B}
.reply-bar .rb-body{flex:1;overflow:hidden}
.reply-bar .rb-author{font-weight:700;font-size:.75rem;color:#61993B}
.reply-bar .rb-text{font-size:.75rem;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.reply-bar .rb-close{cursor:pointer;color:#aaa;font-size:.9rem;padding:2px}
.reply-bar .rb-close:hover{color:#dc3545}
.msg-bubble .reply-btn{position:absolute;top:2px;right:4px;opacity:0;font-size:.7rem;color:#888;cursor:pointer;background:rgba(255,255,255,.8);border-radius:4px;padding:1px 4px;transition:opacity .15s}
.msg-bubble:hover .reply-btn{opacity:1}
.msg-actions{position:absolute;top:2px;right:4px;opacity:0;display:flex;gap:1px;transition:opacity .15s}
.msg-bubble:hover .msg-actions{opacity:1}
.msg-act-btn{font-size:.7rem;color:#888;cursor:pointer;background:rgba(255,255,255,.85);border-radius:4px;padding:1px 4px;border:none}
.msg-act-btn:hover{color:#333;background:rgba(255,255,255,1)}
</style>
{% endblock %}
{% block content %}
<div class="chat-wrap">
    <div class="ch-side">
        <div class="ch-side-head">
            <h6 class="mb-0 fw-bold"><i class="bi bi-chat-dots me-2"></i>Chat</h6>
            <div class="dropdown">
                <button class="btn btn-sm btn-hsl dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-plus"></i></button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="showNewChat('direct')"><i class="bi bi-person me-2"></i>Chat Direct</a></li>
                    <li><a class="dropdown-item" href="#" onclick="showNewChat('grup')"><i class="bi bi-people me-2"></i>Chat Grup</a></li>
                </ul>
            </div>
        </div>
        <div class="ch-side-list" id="convList"></div>
    </div>

    <div class="ch-main">
        <div class="ch-head" id="chatHead"></div>
        <div class="ch-msgs" id="chatMsgs" style="background:#efeae2"></div>
        <div class="ch-input" id="chatInput" style="display:none;position:relative">
            <div id="hashPicker" class="hash-picker" style="display:none"></div>
            <div id="replyBar" class="reply-bar" style="display:none">
                <div class="rb-body"><div class="rb-author" id="replyAuthor"></div><div class="rb-text" id="replyText"></div></div>
                <span class="rb-close" onclick="clearReply()"><i class="bi bi-x-lg"></i></span>
            </div>
            <div id="filePreview" style="display:none"></div>
            <div class="ch-input-row">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()" title="Ata»ôeazƒÉ fi»ôier"><i class="bi bi-paperclip"></i></button>
                <input type="file" id="fileInput" style="display:none" onchange="fileSelected(this)">
                <textarea id="msgBox" rows="1" placeholder="Scrie un mesaj..."></textarea>
                <button class="send-btn" onclick="sendMsg()" title="Trimite"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
<div class="modal-dialog modal-sm"><div class="modal-content">
<div class="modal-header py-2"><h6 class="modal-title" id="ncTitle">Chat Nou</h6><button class="btn-close btn-close-sm" data-bs-dismiss="modal"></button></div>
<div class="modal-body" id="ncBody"></div>
<div class="modal-footer py-2"><button class="btn btn-hsl btn-sm" onclick="createChat()">CreeazƒÉ</button></div>
</div></div></div>
{% endblock %}
{% block scripts %}
<script>
const ME = {{ current_user.id }};
const USERS = {{ users|tojson if users is defined else '[]'|safe }};
let activeConv = null, lastMsgId = 0, pollTimer = null, convPollTimer = null;
let renderState = {lastDate:'', lastAuthor:0, lastMinute:''};

// Color palette for users
const nameColors = ['#1fa855','#e6772e','#7c64d6','#d4447c','#0d94c3','#c95c2e','#4e8ccc','#bf9630'];
const bubbleClasses = ['bubble-c0','bubble-c1','bubble-c2','bubble-c3','bubble-c4','bubble-c5','bubble-c6','bubble-c7'];
const userColorMap = {};
let colorIdx = 0;
function getUserColor(id){
    if(!userColorMap[id]){userColorMap[id]={name:nameColors[colorIdx%nameColors.length],bubble:bubbleClasses[colorIdx%bubbleClasses.length]};colorIdx++;}
    return userColorMap[id];
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ‚ïê‚ïê‚ïê CONVERSATIONS ‚ïê‚ïê‚ïê
function loadConvs(){
    fetch('/api/chat/conversatii').then(r=>r.json()).then(d=>{
        const el=document.getElementById('convList');
        if(!d.conversatii.length){el.innerHTML='<div class="p-4 text-center text-muted small">Nicio conversa»õie</div>';return;}
        el.innerHTML=d.conversatii.map(c=>{
            const isActive=activeConv&&activeConv==c.id;
            const uc=getUserColor(c.id);
            const avBg=c.tip==='document'?'#fd7e14':c.tip==='grup'?'#0d6efd':uc.name;
            const avText=c.tip==='document'?'üìã':c.tip==='grup'?c.nume.charAt(0).toUpperCase():esc(c.nume.charAt(0).toUpperCase());
            const hasUnread=c.necitite>0;
            const dot=hasUnread?'<div style="position:absolute;bottom:0;right:0;width:12px;height:12px;background:#61993B;border-radius:50%;border:2px solid #fff"></div>':'';
            const nameStyle=hasUnread?'font-weight:800':'font-weight:600';
            const previewStyle=hasUnread?'color:#333;font-weight:500':'';
            const timeStyle=hasUnread?'color:#61993B;font-weight:700':'';
            const timeHtml=c.ultimul_timp?'<div class="time" style="'+timeStyle+'">'+c.ultimul_timp+'</div>':'';
            const badgeHtml=hasUnread?'<div class="unread">'+c.necitite+'</div>':'';
            const previewText=c.ultimul_autor?esc(c.ultimul_autor)+': ':'';
            return `<div class="ch-conv${isActive?' active':''}" onclick="openConv(${c.id})">
                <div style="position:relative">
                    <div class="av" style="background:${avBg}">${avText}</div>
                    ${dot}
                </div>
                <div class="info"><div class="name" style="${nameStyle}">${esc(c.nume)}</div>
                <div class="preview" style="${previewStyle}">${previewText}${esc(c.ultimul_mesaj)||'<i>Niciun mesaj</i>'}</div></div>
                <div class="meta">${timeHtml}${badgeHtml}</div>
            </div>`;
        }).join('');
    });
}

// ‚ïê‚ïê‚ïê OPEN CONVERSATION ‚ïê‚ïê‚ïê
function openConv(id){
    if(activeConv===id) return;
    activeConv=id; lastMsgId=0;
    history.replaceState(null,'','/admin/chat?c='+id);
    document.getElementById('chatMsgs').innerHTML='<div class="text-center text-muted p-3"><div class="spinner-border spinner-border-sm"></div></div>';
    document.getElementById('chatInput').style.display='';
    document.getElementById('msgBox').focus();
    document.querySelectorAll('.ch-conv').forEach(el=>el.classList.remove('active'));
    loadMessages(true);
    if(pollTimer) clearInterval(pollTimer);
    pollTimer=setInterval(()=>loadMessages(false), 3000);
}

// ‚ïê‚ïê‚ïê LOAD MESSAGES ‚ïê‚ïê‚ïê
function loadMessages(full){
    if(!activeConv)return;
    const url=full?`/api/chat/mesaje/${activeConv}`:`/api/chat/mesaje/${activeConv}?after=${lastMsgId}`;
    fetch(url).then(r=>r.json()).then(d=>{
        if(full||d.conv_nume){
            const uc=getUserColor(activeConv);
            document.getElementById('chatHead').innerHTML=`
                <div class="av" style="width:36px;height:36px;font-size:.8rem;background:${d.conv_tip==='document'?'#fd7e14':d.conv_tip==='grup'?'#0d6efd':uc.name};border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${d.conv_tip==='document'?'üìã':esc(d.conv_nume.charAt(0))}</div>
                <div style="flex:1"><div class="title">${esc(d.conv_nume)}</div></div>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteConv()" title="»òterge conversa»õia" style="border:none;font-size:.8rem"><i class="bi bi-trash3"></i></button>`;
        }
        if(full){
            renderAllMessages(d.mesaje);
            loadConvs(); // refresh sidebar after read-marking
        } else if(d.mesaje.length) {
            appendMessages(d.mesaje);
        }
    });
}

function renderAllMessages(msgs){
    const el=document.getElementById('chatMsgs');
    if(!msgs.length){el.innerHTML='<div class="ch-empty"><i class="bi bi-chat" style="font-size:2rem"></i><div class="small">Niciun mesaj. Scrie primul!</div></div>';return;}
    renderState={lastDate:'',lastAuthor:0,lastMinute:''};
    el.innerHTML=buildMessagesHtml(msgs, false);
    el.scrollTop=el.scrollHeight;
    if(msgs.length) lastMsgId=msgs[msgs.length-1].id;
    loadConvs();
    resolveDocCards(el);
}

function appendMessages(msgs){
    const el=document.getElementById('chatMsgs');
    const wasBottom=el.scrollTop >= el.scrollHeight - el.clientHeight - 60;
    const empty=el.querySelector('.ch-empty');
    if(empty){empty.remove();renderState={lastDate:'',lastAuthor:0,lastMinute:''};}
    el.insertAdjacentHTML('beforeend', buildMessagesHtml(msgs, true));
    if(wasBottom) el.scrollTop=el.scrollHeight;
    if(msgs.length) lastMsgId=msgs[msgs.length-1].id;
    loadConvs();
    resolveDocCards(el);
}

function buildMessagesHtml(msgs, animate){
    let html='';
    msgs.forEach(m=>{
        if(m.data!==renderState.lastDate){
            html+=`<div class="date-sep"><span>${m.data}</span></div>`;
            renderState.lastAuthor=0; renderState.lastDate=m.data; renderState.lastMinute='';
        }
        const sameAuthor=(m.autor_id===renderState.lastAuthor);
        const mMin=parseInt(m.ora.split(':')[0])*60+parseInt(m.ora.split(':')[1]);
        const lMin=renderState.lastMinute?parseInt(renderState.lastMinute.split(':')[0])*60+parseInt(renderState.lastMinute.split(':')[1]):0;
        const closeTime=renderState.lastMinute&&Math.abs(mMin-lMin)<=5;
        const grouped=sameAuthor&&closeTime;
        const anim=animate?' msg-new':'';
        const isMine=m.autor_id===ME;
        const uc=getUserColor(m.autor_id);
        const bubbleCls=isMine?'mine':('other '+uc.bubble);
        const firstInGroup=!grouped?' first-in-group':'';

        let content='';
        // Reply quote
        if(m.reply){
            const rc=getUserColor(m.reply.autor_id||0);
            const replyPreview=m.reply.fisier?'üìé '+m.reply.fisier:(m.reply.text||'');
            content+=`<div class="reply-quote" style="border-color:${rc.name}" onclick="scrollToMsg(${m.reply.id})">
                <div class="rq-author" style="color:${rc.name}">${esc(m.reply.autor)}</div>
                <div class="rq-text">${esc(replyPreview)}</div>
            </div>`;
        }
        // Author name (only for others, only on first in group)
        if(!isMine&&!grouped){
            content+=`<div class="author" style="color:${uc.name}">${esc(m.autor)}</div>`;
        }
        // File
        if(m.fisier){
            content+=renderFile(m.fisier);
        }
        // Text + time + read ticks
        const ticks = isMine ? renderTicks(m) : '';
        if(m.text){
            content+=`<div class="text-with-time"><span class="text">${formatMsg(m.text)}</span><span class="msg-time">${m.ora}${ticks}</span></div>`;
        } else {
            content+=`<div style="text-align:right"><span class="msg-time">${m.ora}${ticks}</span></div>`;
        }

        // Action buttons (hover)
        const replyClick=`setReply(${m.id},'${esc(m.autor).replace(/'/g,"\\'")}','${esc((m.text||'').substring(0,80)).replace(/'/g,"\\'")}')`;
        const delBtn=isMine||ME===1?`<span class="msg-act-btn" onclick="event.stopPropagation();deleteMsg(${m.id})" title="»òterge"><i class="bi bi-trash3"></i></span>`:'';
        const actBar=`<span class="msg-actions"><span class="msg-act-btn" onclick="event.stopPropagation();${replyClick}" title="RƒÉspunde"><i class="bi bi-reply-fill"></i></span>${delBtn}</span>`;
        html+=`<div class="msg-row${firstInGroup}${anim}" data-msg-id="${m.id}"><div class="msg-bubble ${bubbleCls}" style="position:relative">${actBar}${content}</div></div>`;

        renderState.lastAuthor=m.autor_id; renderState.lastMinute=m.ora;
    });
    return html;
}

function formatMsg(text){
    let s=esc(text);
    s=s.replace(/\n/g,'<br>');
    s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    s=s.replace(/`(.+?)`/g,'<code style="background:rgba(0,0,0,.06);padding:1px 4px;border-radius:3px;font-size:.85em">$1</code>');
    // Document references #[type:title] format
    s=s.replace(/#\[(\w+):([^\]]+)\]/g,(match,type,title)=>{
        const ti=typeIcons[type]||{icon:'bi-file',color:'#888'};
        return `<span class="doc-ref" data-type="${type}" data-title="${title}" style="color:${ti.color};font-weight:600;cursor:pointer"><i class="bi ${ti.icon}" style="font-size:.75em;margin-right:2px"></i>${title}</span>`;
    });
    return s;
}

// Resolve document cards after rendering messages
function resolveDocCards(container){
    const refs=[];
    container.querySelectorAll('.doc-ref:not([data-resolved])').forEach(el=>{
        refs.push({type:el.dataset.type, title:el.dataset.title, el:el});
    });
    if(!refs.length)return;
    const uniqueRefs=[...new Set(refs.map(r=>r.type+':'+r.title))].map(k=>{
        const [type,title]=k.split(':',2);
        // Reconstruct full title in case it had colons
        return {type, title:k.substring(type.length+1)};
    });
    fetch('/api/chat/resolve',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({refs:uniqueRefs})
    }).then(r=>r.json()).then(d=>{
        if(!d.cards.length)return;
        const cardMap={};
        d.cards.forEach(c=>cardMap[c.type+':'+c.search_key]=c);
        refs.forEach(({type,title,el})=>{
            const card=cardMap[type+':'+title];
            if(!card||el.dataset.resolved)return;
            el.dataset.resolved='1';
            el.style.cursor='pointer';
            el.onclick=()=>window.open(card.url,'_blank');
            // Insert card after parent bubble
            const bubble=el.closest('.msg-bubble');
            if(bubble&&!bubble.querySelector('.doc-card')){
                const cardEl=document.createElement('a');
                cardEl.href=card.url;
                cardEl.className='doc-card';
                cardEl.innerHTML=`<div class="dc-bar" style="background:${card.color}"></div>
                    <div class="dc-body">
                        <div class="dc-title"><i class="bi ${card.icon} me-1" style="color:${card.color}"></i>${esc(card.titlu)}</div>
                        ${card.subtitlu?'<div class="dc-sub">'+esc(card.subtitlu)+'</div>':''}
                        <div class="dc-footer">
                            ${card.status?'<span class="dc-status" style="background:'+card.color+'20;color:'+card.color+'">'+esc(card.status)+'</span>':''}
                            ${card.total?'<span class="dc-total">'+esc(card.total)+'</span>':''}
                        </div>
                    </div>`;
                bubble.appendChild(cardEl);
            }
        });
    });
}

function renderFile(f){
    if(!f)return '';
    if(f.tip==='image'){
        return `<div><img src="${f.path}" class="msg-img" onclick="window.open('${f.path}','_blank')" alt="${esc(f.nume)}"></div>`;
    }
    const icons={'document':'bi-file-earmark-text text-danger','other':'bi-file-earmark text-secondary'};
    const icon=icons[f.tip]||icons.other;
    return `<a href="${f.path}" target="_blank" download class="file-attach">
        <i class="bi ${icon} f-icon"></i>
        <div style="overflow:hidden"><div class="f-name">${esc(f.nume)}</div><div class="f-size">${formatSize(f.size)}</div></div>
        <i class="bi bi-download" style="font-size:.75rem;color:#888;margin-left:auto"></i>
    </a>`;
}

function formatSize(b){
    if(!b)return '';
    if(b<1024)return b+' B';
    if(b<1048576)return (b/1024).toFixed(1)+' KB';
    return (b/1048576).toFixed(1)+' MB';
}

function renderTicks(m){
    if(!m.citit) return '';
    const isRead = m.citit.status==='read';
    const cls = isRead ? 'tick-read' : 'tick-sent';
    // Single check for sent, double check for read (WhatsApp-style SVG)
    const svg = isRead
        ? `<svg viewBox="0 0 16 11"><path d="M11.07 0.73L4.44 7.36 2.7 5.62" stroke-linecap="round" stroke-linejoin="round"/><path d="M14.07 0.73L7.44 7.36 6.2 6.12" stroke-linecap="round" stroke-linejoin="round"/></svg>`
        : `<svg viewBox="0 0 16 11"><path d="M11.07 0.73L4.44 7.36 1.93 4.85" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    return `<span class="read-ticks ${cls}" onclick="event.stopPropagation();showReadInfo(${m.id},this)">${svg}</span>`;
}

let activePopup=null;
function showReadInfo(msgId,el){
    closeReadPopup();
    fetch('/api/chat/citiri/'+msgId).then(r=>r.json()).then(d=>{
        const popup=document.createElement('div');
        popup.className='read-info';
        popup.id='readPopup';
        let html='';
        if(d.citit.length){
            d.citit.forEach((r,i)=>{
                html+=`<div class="ri-row"><span class="ri-name">${esc(r.nume)}</span><span class="ri-time">${r.data}</span></div>`;
            });
        }
        if(d.necitit.length){
            if(d.citit.length) html+='<div class="ri-divider"></div>';
            d.necitit.forEach(r=>{html+=`<div class="ri-unseen">${esc(r.nume)} ‚Äî nu a vƒÉzut</div>`;});
        }
        if(!d.citit.length&&!d.necitit.length){
            html='<div class="ri-unseen">Doar tu</div>';
        }
        popup.innerHTML=html;
        document.body.appendChild(popup);
        const rect=el.getBoundingClientRect();
        const pw=popup.offsetWidth||180;
        popup.style.top=Math.max(10, rect.top-popup.offsetHeight-6)+'px';
        popup.style.left=Math.min(window.innerWidth-pw-10, Math.max(10, rect.left-pw+20))+'px';
        activePopup=popup;
    });
}
function closeReadPopup(){
    const p=document.getElementById('readPopup');if(p)p.remove();activePopup=null;
}
document.addEventListener('click',()=>closeReadPopup());

// ‚ïê‚ïê‚ïê SEND MESSAGE ‚ïê‚ïê‚ïê
let sending=false, pendingFile=null, replyToId=null;

function setReply(id, autor, text){
    replyToId=id;
    document.getElementById('replyBar').style.display='';
    document.getElementById('replyAuthor').textContent=autor;
    document.getElementById('replyText').textContent=text||'üìé Fi»ôier';
    document.getElementById('msgBox').focus();
}
function clearReply(){
    replyToId=null;
    document.getElementById('replyBar').style.display='none';
}
function scrollToMsg(id){
    const row=document.querySelector(`[data-msg-id="${id}"]`);
    if(row){
        row.scrollIntoView({behavior:'smooth',block:'center'});
        row.querySelector('.msg-bubble').style.transition='background .3s';
        row.querySelector('.msg-bubble').style.background='rgba(97,153,59,.15)';
        setTimeout(()=>{row.querySelector('.msg-bubble').style.background='';},1500);
    }
}

function deleteMsg(id){
    if(!confirm('»òterge mesajul?'))return;
    fetch(`/api/chat/mesaj/${id}/sterge`,{method:'POST',headers:{'Content-Type':'application/json'}})
    .then(r=>r.json()).then(d=>{
        if(d.success){
            const row=document.querySelector(`[data-msg-id="${id}"]`);
            if(row){row.style.transition='opacity .2s';row.style.opacity='0';setTimeout(()=>row.remove(),200);}
            loadConvs();
        } else alert(d.error||'Eroare');
    });
}

function deleteConv(){
    if(!activeConv)return;
    if(!confirm('»òterge aceastƒÉ conversa»õie?'))return;
    fetch(`/api/chat/conversatie/${activeConv}/sterge`,{method:'POST',headers:{'Content-Type':'application/json'}})
    .then(r=>r.json()).then(d=>{
        if(d.success){
            activeConv=null;lastMsgId=0;
            if(pollTimer){clearInterval(pollTimer);pollTimer=null;}
            document.getElementById('chatHead').innerHTML='';
            document.getElementById('chatMsgs').innerHTML='';
            document.getElementById('chatInput').style.display='none';
            history.replaceState(null,'','/admin/chat');
            loadConvs();
        }
    });
}

function sendMsg(){
    const box=document.getElementById('msgBox');
    const txt=box.value.trim();
    if((!txt&&!pendingFile)||!activeConv||sending)return;
    sending=true;
    box.value=''; box.style.height='auto';
    if(pollTimer){clearInterval(pollTimer);pollTimer=null;}

    let fetchOpts;
    if(pendingFile){
        const fd=new FormData();
        fd.append('conversatie_id',activeConv);
        fd.append('text',txt);
        fd.append('fisier',pendingFile);
        if(replyToId) fd.append('reply_to_id',replyToId);
        fetchOpts={method:'POST',body:fd};
        clearFile();
    } else {
        const body={conversatie_id:activeConv,text:txt};
        if(replyToId) body.reply_to_id=replyToId;
        fetchOpts={method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify(body)};
    }
    clearReply();

    fetch('/api/chat/trimite',fetchOpts).then(r=>r.json()).then(d=>{
        if(d.success){
            return fetch(`/api/chat/mesaje/${activeConv}?after=${lastMsgId}`).then(r=>r.json());
        }
    }).then(d=>{
        if(d&&d.mesaje.length) appendMessages(d.mesaje);
        sending=false;
        pollTimer=setInterval(()=>loadMessages(false), 3000);
    }).catch(()=>{sending=false;pollTimer=setInterval(()=>loadMessages(false),3000);});
}

// ‚ïê‚ïê‚ïê FILE HANDLING ‚ïê‚ïê‚ïê
function fileSelected(input){
    const file=input.files[0];
    if(!file)return;
    pendingFile=file;
    showFilePreview(file);
    input.value='';
}
function showFilePreview(file){
    const prev=document.getElementById('filePreview');
    prev.style.display='';
    const isImg=file.type.startsWith('image/');
    prev.innerHTML=`<div class="file-preview">
        <i class="bi ${isImg?'bi-image text-success':'bi-file-earmark text-primary'}"></i>
        <span class="flex-grow-1 text-truncate">${esc(file.name)}</span>
        <span class="text-muted">${formatSize(file.size)}</span>
        <span class="remove" onclick="clearFile()"><i class="bi bi-x-lg"></i></span>
    </div>`;
}
function clearFile(){
    pendingFile=null;
    const p=document.getElementById('filePreview');
    p.style.display='none';p.innerHTML='';
}

// ‚ïê‚ïê‚ïê INPUT + # AUTOCOMPLETE ‚ïê‚ïê‚ïê
let hashMode=false, hashQuery='', hashTimer=null, hashIdx=-1;
const typeIcons={client:{icon:'bi-people',color:'#61993B'},oferta:{icon:'bi-file-earmark-text',color:'#fd7e14'},
    comanda:{icon:'bi-cart-check',color:'#0d6efd'},produs:{icon:'bi-box',color:'#6f42c1'},
    nir:{icon:'bi-box-arrow-in-down',color:'#0dcaf0'},factura:{icon:'bi-receipt',color:'#dc3545'},
    activitate:{icon:'bi-list-check',color:'#20c997'}};

document.addEventListener('DOMContentLoaded',()=>{
    const box=document.getElementById('msgBox');
    if(!box)return;
    box.addEventListener('input',()=>{
        box.style.height='auto';box.style.height=Math.min(box.scrollHeight,120)+'px';
        checkHashMode(box);
    });
    box.addEventListener('keydown',(e)=>{
        if(hashMode){
            const picker=document.getElementById('hashPicker');
            const items=picker.querySelectorAll('.hp-item');
            if(e.key==='ArrowDown'){e.preventDefault();hashIdx=Math.min(hashIdx+1,items.length-1);highlightHash(items);return;}
            if(e.key==='ArrowUp'){e.preventDefault();hashIdx=Math.max(hashIdx-1,0);highlightHash(items);return;}
            if(e.key==='Enter'&&hashIdx>=0&&items[hashIdx]){e.preventDefault();items[hashIdx].click();return;}
            if(e.key==='Escape'){closeHashPicker();return;}
        }
        if(e.key==='Enter'&&!e.shiftKey&&!hashMode){e.preventDefault();sendMsg();}
    });
});

function checkHashMode(box){
    const val=box.value, pos=box.selectionStart;
    // Find # before cursor
    const before=val.substring(0,pos);
    const hashMatch=before.match(/#(\S*)$/);
    if(hashMatch){
        hashMode=true;
        hashQuery=hashMatch[1];
        hashIdx=-1;
        if(hashQuery.length>=1){
            clearTimeout(hashTimer);
            hashTimer=setTimeout(()=>searchHash(hashQuery),200);
        } else {
            showHashHint();
        }
    } else {
        closeHashPicker();
    }
}

function showHashHint(){
    const picker=document.getElementById('hashPicker');
    picker.style.display='';
    picker.innerHTML='<div class="hp-empty"><i class="bi bi-search me-1"></i>Scrie pentru a cƒÉuta comenzi, oferte, produse...</div>';
}

function searchHash(q){
    fetch('/api/search?q='+encodeURIComponent(q)).then(r=>r.json()).then(d=>{
        const picker=document.getElementById('hashPicker');
        if(!hashMode){picker.style.display='none';return;}
        picker.style.display='';
        if(!d.results.length){
            picker.innerHTML='<div class="hp-empty">Niciun rezultat pentru "'+esc(q)+'"</div>';
            return;
        }
        picker.innerHTML=d.results.slice(0,8).map((r,i)=>{
            const ti=typeIcons[r.type]||{icon:'bi-file',color:'#888'};
            // Store type:title as ref
            const ref=`#[${r.type}:${r.title}]`;
            return `<div class="hp-item${i===hashIdx?' active':''}" data-ref="${esc(ref)}" data-url="${esc(r.url||'')}">
                <div class="hp-icon" style="background:${ti.color}"><i class="bi ${ti.icon}"></i></div>
                <div class="hp-info"><div class="hp-title">${esc(r.title)}</div><div class="hp-sub">${esc(r.subtitle||'')}</div></div>
                <span style="font-size:.6rem;color:#aaa;text-transform:uppercase">${r.type}</span>
            </div>`;
        }).join('');
        picker.querySelectorAll('.hp-item').forEach(el=>{
            el.addEventListener('click',()=>insertHashRef(el.dataset.ref));
        });
    });
}

function highlightHash(items){
    items.forEach((el,i)=>el.classList.toggle('active',i===hashIdx));
    if(items[hashIdx])items[hashIdx].scrollIntoView({block:'nearest'});
}

function insertHashRef(ref){
    const box=document.getElementById('msgBox');
    const val=box.value, pos=box.selectionStart;
    const before=val.substring(0,pos);
    const after=val.substring(pos);
    // Replace #query with #REF
    const newBefore=before.replace(/#\S*$/,ref+' ');
    box.value=newBefore+after;
    box.selectionStart=box.selectionEnd=newBefore.length;
    box.focus();
    closeHashPicker();
}

function closeHashPicker(){
    hashMode=false;hashQuery='';hashIdx=-1;
    document.getElementById('hashPicker').style.display='none';
}

// ‚ïê‚ïê‚ïê NEW CHAT ‚ïê‚ïê‚ïê
let newChatType='direct';
function showNewChat(type){
    newChatType=type;
    const body=document.getElementById('ncBody');
    document.getElementById('ncTitle').textContent=type==='direct'?'Chat Direct':'Chat Grup';
    if(type==='direct'){
        body.innerHTML=USERS.map(u=>`<div class="nc-item d-flex align-items-center gap-2 p-2 rounded" style="cursor:pointer" onclick="this.querySelector('input').checked=true;document.querySelectorAll('.nc-item').forEach(x=>x.style.background='');this.style.background='#e8f5e9'">
            <input type="radio" name="du" value="${u.id}" class="d-none">
            <div style="width:30px;height:30px;border-radius:50%;background:${getUserColor(u.id).name};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.7rem">${esc(u.nume_complet.charAt(0))}</div>
            <span class="small fw-bold">${esc(u.nume_complet)}</span>
        </div>`).join('');
    } else {
        body.innerHTML=`<input id="grpName" class="form-control form-control-sm mb-2" placeholder="Nume grup...">
        <div class="small fw-bold mb-1">Membri:</div>`+
        USERS.map(u=>`<div class="form-check"><input class="form-check-input" type="checkbox" name="gu" value="${u.id}" id="gu${u.id}"><label class="form-check-label small" for="gu${u.id}">${esc(u.nume_complet)}</label></div>`).join('');
    }
    new bootstrap.Modal('#newChatModal').show();
}
function createChat(){
    let body={};
    if(newChatType==='direct'){
        const sel=document.querySelector('input[name=du]:checked');
        if(!sel)return alert('SelecteazƒÉ un utilizator');
        body={tip:'direct',membri:[parseInt(sel.value)]};
    } else {
        const ids=[...document.querySelectorAll('input[name=gu]:checked')].map(c=>parseInt(c.value));
        if(!ids.length)return alert('SelecteazƒÉ membri');
        body={tip:'grup',membri:ids,nume:document.getElementById('grpName').value||'Grup'};
    }
    fetch('/api/chat/nou',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
    .then(r=>r.json()).then(d=>{
        if(d.success){
            bootstrap.Modal.getInstance(document.getElementById('newChatModal')).hide();
            loadConvs();
            setTimeout(()=>openConv(d.conversatie_id),300);
        }
    });
}

// ‚ïê‚ïê‚ïê DRAG & DROP + PASTE ‚ïê‚ïê‚ïê
const chatMain=document.querySelector('.ch-main');
if(chatMain){
    chatMain.addEventListener('dragover',e=>{e.preventDefault();
        if(!document.getElementById('dropOverlay')&&activeConv){
            const ov=document.createElement('div');ov.id='dropOverlay';ov.className='drop-overlay';
            ov.innerHTML='<span><i class="bi bi-cloud-upload me-2"></i>Trage fi»ôierul aici</span>';
            chatMain.appendChild(ov);
        }
    });
    chatMain.addEventListener('dragleave',e=>{e.preventDefault();
        const ov=document.getElementById('dropOverlay');
        if(ov&&!chatMain.contains(e.relatedTarget))ov.remove();
    });
    chatMain.addEventListener('drop',e=>{e.preventDefault();
        const ov=document.getElementById('dropOverlay');if(ov)ov.remove();
        if(e.dataTransfer.files.length&&activeConv){pendingFile=e.dataTransfer.files[0];showFilePreview(pendingFile);}
    });
}
document.addEventListener('paste',e=>{
    if(!activeConv)return;
    const items=e.clipboardData?.items;if(!items)return;
    for(let i=0;i<items.length;i++){
        if(items[i].type.startsWith('image/')){
            pendingFile=items[i].getAsFile();
            if(pendingFile)showFilePreview(pendingFile);
            break;
        }
    }
});

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
loadConvs();
convPollTimer=setInterval(loadConvs, 10000);
const urlC=new URLSearchParams(location.search).get('c');
if(urlC) openConv(parseInt(urlC));
</script>
{% endblock %}
