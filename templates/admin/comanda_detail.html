{% extends 'admin/layout.html' %}
{% block title %}Comanda {{ comanda.numar }} - HSL ERP{% endblock %}
{% block head %}
<style>
.pipeline{display:flex;gap:0;margin:12px 0 4px}
.pipe-step{flex:1;text-align:center;position:relative;padding:6px 0}
.pipe-step .dot{width:20px;height:20px;border-radius:50%;margin:0 auto 2px;border:2px solid #dee2e6;background:#fff;position:relative;z-index:1}
.pipe-step .lbl{font-size:.6rem;text-transform:uppercase;letter-spacing:.3px;color:#adb5bd}
.pipe-step.done .dot{background:#61993B;border-color:#61993B}
.pipe-step.active .dot{background:#ffc107;border-color:#ffc107;box-shadow:0 0 0 4px rgba(255,193,7,.3)}
.pipe-step.done .lbl{color:#61993B;font-weight:700}
.pipe-step.active .lbl{color:#1D2F34;font-weight:700}
.pipe-step::before{content:'';position:absolute;top:15px;left:0;right:50%;height:2px;background:#dee2e6;z-index:0}
.pipe-step::after{content:'';position:absolute;top:15px;left:50%;right:0;height:2px;background:#dee2e6;z-index:0}
.pipe-step:first-child::before{display:none}
.pipe-step:last-child::after{display:none}
.pipe-step.done::before,.pipe-step.done::after{background:#61993B}
.pipe-step.active::before{background:#61993B}
</style>
{% endblock %}
{% block content %}
{% set steps = [('pending','Aprobare'),('noua','Nouă'),('confirmata','Confirmată'),('productie','Producție'),('gata','Gata'),('livrata','Livrată'),('finalizata','Finalizată')] %}
{% set step_codes = steps|map(attribute=0)|list %}
{% set cur_idx = step_codes.index(comanda.status) if comanda.status in step_codes else -1 %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div><h2><i class="bi bi-cart-check me-2"></i>{{ comanda.numar }}</h2>
        <span class="badge bg-{% if comanda.status=='pending' %}warning text-dark{% elif comanda.status=='noua' %}secondary{% elif comanda.status=='confirmata' %}primary{% elif comanda.status=='productie' %}warning text-dark{% elif comanda.status=='gata' %}info{% elif comanda.status=='livrata' %}success{% elif comanda.status=='finalizata' %}dark{% else %}danger{% endif %} fs-6">{{ comanda.status_display }}</span>
    </div>
    <div class="d-flex gap-2 align-items-center">
        {# === PENDING: only approve button for admin/director === #}
        {% if comanda.status == 'pending' %}
            {% if current_user.is_admin %}
            <button class="btn btn-success" onclick="approveComanda()"><i class="bi bi-check-circle me-1"></i>Aprobă Comanda</button>
            <button class="btn btn-outline-danger" onclick="rejectComanda()"><i class="bi bi-x-circle me-1"></i>Respinge</button>
            {% else %}
            <span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Așteptare aprobare admin</span>
            {% endif %}
        {% endif %}

        {# === NEXT STATUS (single colored button) === #}
        {% if comanda.status == 'noua' %}<button class="btn btn-primary" onclick="setStatus('confirmata')"><i class="bi bi-check-lg me-1"></i>Confirmă</button>{% endif %}
        {% if comanda.status == 'confirmata' %}<button class="btn btn-warning" onclick="setStatus('productie')"><i class="bi bi-gear me-1"></i>În Producție</button>{% endif %}
        {% if comanda.status == 'productie' %}<button class="btn btn-info text-white" onclick="setStatus('gata')"><i class="bi bi-box-seam me-1"></i>Gata Livrare</button>{% endif %}
        {% if comanda.status == 'gata' %}<button class="btn btn-success" onclick="setStatus('livrata')"><i class="bi bi-truck me-1"></i>Livrată</button>{% endif %}
        {% if comanda.status == 'livrata' %}<button class="btn btn-dark" onclick="setStatus('finalizata')"><i class="bi bi-check-circle me-1"></i>Finalizează</button>{% endif %}

        {# === SECONDARY ACTIONS (outline) === #}
        {% if comanda.status in ['livrata','finalizata'] %}
        <button class="btn btn-outline-warning" onclick="genFactura()"><i class="bi bi-receipt me-1"></i>Factură Fiscală</button>
        {% endif %}
        {% if comanda.status in ['confirmata','productie','gata'] %}
        <button class="btn btn-outline-primary" onclick="genPicking()"><i class="bi bi-cart-check me-1"></i>Picking</button>
        {% endif %}

        {# === DROPDOWN "MAI MULTE" === #}
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="openDocChat();return false;"><i class="bi bi-chat-dots me-2 text-primary"></i>Chat Comandă</a></li>
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="dropdown" id="shareMenuTrigger" onclick="event.stopPropagation();document.getElementById('shareSubmenu').classList.toggle('d-none')">
                        <i class="bi bi-share me-2 text-info"></i>Trimite pe Chat
                    </a>
                    <div id="shareSubmenu" class="d-none px-3 py-2" style="max-height:200px;overflow-y:auto">
                        <div id="shareConvList"><small class="text-muted">Se încarcă...</small></div>
                    </div>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#" onclick="stergeComanda();return false;"><i class="bi bi-trash me-2"></i>Șterge Comanda</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Status Pipeline -->
{% if comanda.status == 'pending' %}
<div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
    <i class="bi bi-hourglass-split fs-4 me-3"></i>
    <div>
        <strong>Comandă în așteptare aprobare</strong><br>
        <small>Proforma este confirmată de client dar neplătită. Un administrator sau director vânzări trebuie să aprobe comanda înainte de a putea continua.</small>
    </div>
</div>
{% endif %}
{% if comanda.status != 'anulat' %}
<div class="bg-white rounded-3 px-4 py-1 mb-3">
    <div class="pipeline">
        {% for code, label in steps %}
        <div class="pipe-step {% if loop.index0 < cur_idx %}done{% elif loop.index0 == cur_idx %}active{% endif %}">
            <div class="dot"></div><div class="lbl">{{ label }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Payment Status Banner -->
{% set proforme = comanda.oferta_sursa.proforme.all() if comanda.oferta_sursa else [] %}
{% set fiscale = comanda.facturi|selectattr('tip','equalto','fiscala')|list %}
{% set pf_incasate = proforme|selectattr('status','equalto','incasata')|list %}
{% set pf_confirmate = proforme|selectattr('status','equalto','confirmata')|list %}
{% set pf_ok = pf_incasate or pf_confirmate %}
{% set fc_platite = fiscale|selectattr('status','equalto','incasata')|list %}
{% if proforme or fiscale %}
<div class="rounded-3 px-4 py-2 mb-3">
    {% if proforme %}
    <div class="d-flex align-items-center gap-2 {% if fiscale %}mb-2{% endif %} rounded-3 px-3 py-2 {% if pf_incasate %}bg-success bg-opacity-10 border border-success{% elif pf_confirmate %}bg-info bg-opacity-10 border border-info{% else %}bg-warning bg-opacity-10 border border-warning{% endif %}">
        {% if pf_incasate %}<i class="bi bi-check-circle-fill text-success fs-5"></i><span class="fw-bold text-success">Proformă plătită</span>
        {% elif pf_confirmate %}<i class="bi bi-check2-circle text-info fs-5"></i><span class="fw-bold text-info">Proformă confirmată de client</span>
        {% else %}<i class="bi bi-clock-fill text-warning fs-5"></i><span class="fw-bold text-warning">Așteptare confirmare proformă</span>{% endif %}
        {% for pf in proforme %}
        <a href="/admin/facturi/{{ pf.id }}" class="badge bg-{% if pf.status=='incasata' %}success{% elif pf.status=='confirmata' %}info{% else %}warning text-dark{% endif %} text-decoration-none ms-2">{{ pf.numar_complet }} · {{ '{:,.2f}'.format(pf.total) }} {{ pf.moneda }}</a>
        {% endfor %}
    </div>
    {% endif %}
    {% if fiscale %}
    <div class="d-flex align-items-center gap-2 rounded-3 px-3 py-2 {% if fc_platite or pf_incasate %}bg-success bg-opacity-10 border border-success{% else %}bg-warning bg-opacity-10 border border-warning{% endif %}">
        {% if fc_platite or pf_incasate %}<i class="bi bi-check-circle-fill text-success fs-5"></i>
        <span class="fw-bold text-success">Factură fiscală {% if pf_incasate and not fc_platite %}(acoperită de proformă){% else %}încasată{% endif %}</span>
        {% else %}<i class="bi bi-clock-fill text-warning fs-5"></i><span class="fw-bold text-warning">Așteptare plată factură fiscală</span>{% endif %}
        {% for fc in fiscale %}
        <a href="/admin/facturi/{{ fc.id }}" class="badge bg-{% if fc.status=='incasata' or pf_incasate %}success{% else %}warning text-dark{% endif %} text-decoration-none ms-2">{{ fc.numar_complet }} · {{ '{:,.2f}'.format(fc.total) }} {{ fc.moneda }}</a>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<div class="row g-4">
<div class="col-md-4"><div class="bg-white rounded-3 p-3">
    <h6 class="fw-bold">Detalii</h6>
    <p><strong>Client:</strong> <a href="/admin/clienti/{{ comanda.client_id }}/detalii">{{ comanda.client.nume }}</a></p>
    {% if comanda.oferta_sursa %}<p><strong>Din oferta:</strong> <a href="/admin/oferte/{{ comanda.oferta_id }}">{{ comanda.oferta_sursa.numar }}</a></p>{% endif %}
    <p><strong>Data:</strong> {{ comanda.data_comanda }}</p>
    <hr>
    <h6 class="fw-bold">Facturi Fiscale</h6>
    {% for f in comanda.facturi if f.tip == 'fiscala' %}
    <a href="/admin/facturi/{{ f.id }}" class="d-block">{{ f.numar_complet }} - {{ '{:,.2f}'.format(f.total) }} {{ f.moneda }} <span class="badge bg-{% if f.status=='incasata' %}success{% else %}warning{% endif %}">{{ f.status|title }}</span></a>
    {% else %}<p class="text-muted">Nicio factură fiscală.</p>{% endfor %}
    <hr>
    <h6 class="fw-bold">Mișcări Stoc</h6>
    {% for m in comanda.miscari_stoc %}
    <small>{{ m.tip|title }}: {{ m.cod_produs }} × {{ m.cantitate }}</small><br>
    {% else %}<p class="text-muted">Nicio mișcare.</p>{% endfor %}
    <hr>
    <h6 class="fw-bold d-flex justify-content-between">Activități
        {% if current_user.has_access('activitati_manage') %}
        <a href="/admin/activitati/nou?comanda={{ comanda.id }}" class="btn btn-sm btn-outline-success">+ Adaugă</a>
        {% endif %}
    </h6>
    {% for a in comanda.activitati.order_by(Activitate.ordine).all() %}
    <div class="d-flex align-items-center gap-2 py-1 border-bottom">
        {% if a.status == 'finalizat' %}<i class="bi bi-check-circle-fill text-success"></i>
        {% elif a.status == 'in_lucru' %}<i class="bi bi-play-circle-fill text-primary"></i>
        {% elif a.status == 'in_asteptare' %}<i class="bi bi-pause-circle-fill text-warning"></i>
        {% else %}<i class="bi bi-circle text-muted"></i>{% endif %}
        <a href="/admin/activitati/{{ a.id }}" class="flex-grow-1 {% if a.status=='finalizat' %}text-muted{% endif %}">{{ a.titlu.split(' - ')[0] }}</a>
        {% if a.asignat %}<span class="badge bg-info text-dark" style="font-size:.7rem">{{ a.asignat.nume_complet }}</span>{% endif %}
        <span class="badge bg-{% if a.prioritate=='urgenta' %}danger{% elif a.prioritate=='ridicata' %}warning text-dark{% else %}light text-dark{% endif %}" style="font-size:.7rem">{{ a.prioritate_display }}</span>
    </div>
    {% else %}<p class="text-muted small">Nicio activitate.</p>{% endfor %}
</div></div>
<div class="col-md-8"><div class="bg-white rounded-3 p-3">
    <h6 class="fw-bold mb-3">Linii Comandă</h6>
    <table class="table table-sm table-hsl">
    <thead><tr><th>#</th><th>Cod</th><th>Denumire</th><th>Cant.</th><th>Preț Vânz.</th><th>Valoare</th><th>Cost Achiz.</th><th>Marjă</th></tr></thead>
    <tbody>{% for l in comanda.linii %}
    {% set ml = marja_linii[loop.index0] if marja_linii|length > loop.index0 else {} %}
    <tr><td>{{ loop.index }}</td><td><code>{{ l.cod }}</code></td><td>{{ l.denumire }}</td>
        <td>{{ l.cantitate|int }}</td><td>{{ '{:,.2f}'.format(l.pret_unitar) }}</td><td class="fw-bold">{{ '{:,.2f}'.format(l.valoare_linie) }}</td>
        <td class="text-muted">{{ '{:,.2f}'.format(ml.get('cost',0)) }}</td>
        <td class="fw-bold {% if ml.get('marja',0) >= 0 %}text-success{% else %}text-danger{% endif %}">
            {{ '{:,.0f}'.format(ml.get('marja',0)) }}€ <small class="fw-normal">({{ '{:.0f}'.format(ml.get('marja_pct',0)) }}%)</small>
        </td></tr>
    {% endfor %}</tbody>
    <tfoot>
    <tr><td colspan="5" class="text-end">Subtotal:</td><td class="fw-bold">{{ '{:,.2f}'.format(comanda.subtotal) }}</td><td></td><td></td></tr>
    <tr><td colspan="5" class="text-end">TVA ({{ comanda.tva_procent }}%):</td><td>{{ '{:,.2f}'.format(comanda.tva_valoare) }}</td><td></td><td></td></tr>
    <tr class="table-success"><td colspan="5" class="text-end fw-bold fs-5">TOTAL:</td><td class="fw-bold fs-5">{{ '{:,.2f}'.format(comanda.total) }} {{ comanda.moneda }}</td>
        <td class="text-muted">{{ '{:,.0f}'.format(total_cost) }}€</td>
        <td class="fw-bold {% if marja_totala >= 0 %}text-success{% else %}text-danger{% endif %} fs-5">{{ '{:,.0f}'.format(marja_totala) }}€ <small class="fw-normal">({{ '{:.1f}'.format(marja_totala_pct) }}%)</small></td></tr>
    </tfoot></table>
</div></div></div>
{% endblock %}
{% block scripts %}<script>
function setStatus(s){fetch('/api/comanda/{{ comanda.id }}/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:s})}).then(r=>r.json()).then(d=>{if(d.success)location.reload();else alert(d.error)})}
function approveComanda(){if(!confirm('Aprobă comanda? Aceasta va trece în status „Nouă" și va putea fi procesată.'))return;setStatus('noua')}
function rejectComanda(){if(!confirm('Respinge comanda? Aceasta va fi anulată.'))return;setStatus('anulat')}function genFactura(){if(!confirm('Generează factură fiscală?'))return;fetch('/api/comanda/{{ comanda.id }}/factura',{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'}).then(r=>{if(!r.ok)throw new Error('Status '+r.status);return r.json()}).then(d=>{if(d.success){let msg='Factură '+d.numar+' creată!';if(d.auto_incasata)msg+='\n\n✅ Marcată automat ca încasată (proformă plătită).';alert(msg);location.reload()}else alert('Eroare: '+(d.error||'necunoscută'))}).catch(e=>alert('Eroare: '+e.message))}
function stergeComanda(){if(!confirm('Sigur vrei să ștergi această comandă?\nSe vor șterge și activitățile, mișcările de stoc și facturile asociate!'))return;fetch('/api/comanda/{{ comanda.id }}/sterge',{method:'POST',headers:{'Content-Type':'application/json'}}).then(r=>r.json()).then(d=>{if(d.success){alert('Comanda a fost ștearsă.');location.href='/admin/comenzi'}else alert(d.error)})}
function genPicking(){if(!confirm('Generează picking?'))return;fetch('/api/wms/picking/genereaza/{{ comanda.id }}',{method:'POST',headers:{'Content-Type':'application/json'}}).then(r=>r.json()).then(d=>{if(d.success){alert('Picking '+d.numar+' generat!');location.href='/admin/wms/picking/'+d.picking_id}else alert(d.error)})}
function openDocChat(){fetch('/api/chat/document',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({doc_tip:'comanda',doc_id:{{ comanda.id }},doc_numar:'{{ comanda.numar }}'})}).then(r=>r.json()).then(d=>{if(d.success)location.href='/admin/chat?c='+d.conversatie_id})}
// Share submenu
document.querySelector('.dropdown')?.addEventListener('show.bs.dropdown',function(){
    fetch('/api/chat/conversatii').then(r=>r.json()).then(d=>{
        const el=document.getElementById('shareConvList');
        if(!d.conversatii||!d.conversatii.length){el.innerHTML='<small class="text-muted">Nicio conversație.</small>';return;}
        el.innerHTML=d.conversatii.map(c=>`<div class="d-flex align-items-center gap-2 p-1 rounded" style="cursor:pointer" onclick="shareToConv(${c.id},'${c.nume.replace(/'/g,"\\'")}')" onmouseover="this.style.background='#f0fdf4'" onmouseout="this.style.background=''">
            <i class="bi ${c.tip==='document'?'bi-file-text text-warning':c.tip==='grup'?'bi-people text-primary':'bi-person text-success'}"></i>
            <span class="small text-truncate">${c.nume}</span></div>`).join('');
    });
});
function shareToConv(convId,convName){
    fetch('/api/chat/trimite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversatie_id:convId,text:'#[comanda:{{ comanda.numar }}]'})}).then(r=>r.json()).then(d=>{if(d.success)alert('Trimis în '+convName)});
}
</script>{% endblock %}
